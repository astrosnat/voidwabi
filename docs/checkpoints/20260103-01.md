# Attempting to fix deletion issues

Files end up in backend/uploads because the backend writes uploads to that folder (UPLOADS_DIR in server.ts (line 330)) and the repo’s .gitignore has no entry for backend/uploads, so git add . will happily stage them. They’re also inside the repo tree (not outside it), so builds/commits pick them up unless explicitly ignored.

Why cleanup is failing / leaving stragglers:

Message/file lifecycle is in-memory only. Messages are stored in maps and timers, not persisted. Auto-delete is driven by timers scheduled in scheduleMessageDeletion (server.ts (lines 114-153)) and manual deletes (delete-message handler server.ts (lines 1188-1237)). On server restart those timers and message records vanish, but the files on disk remain, so nothing later knows to delete them.
Bulk cleanup exists only when calling /api/clear-messages (server.ts (lines 796-814)), which removes everything in backend/uploads, but that endpoint isn’t automatic and may never be called in normal use.
Some upload types have no file delete path at all. Custom emoji uploads write into backend/uploads (server.ts (lines 743-785)), but both delete handlers just remove metadata and never unlink the file (server.ts (lines 1348-1362), server.ts (lines 1775-1782)). Profile pictures (/api/upload-profile-picture at server.ts (lines 479-519)) are also never cleaned up. Those accumulate indefinitely.
Message delete is limited to the uploader (server.ts (lines 1188-1237)), so admins/moderators can’t clean up other users’ files unless they clear all messages/files, which can leave orphaned uploads when users leave.
Natural next steps:

Add backend/uploads/ to .gitignore (and .dockerignore) so local/test uploads stop being committed.
Move uploads outside the repo tree or into a dedicated storage bucket, with retention policy.
Add a periodic prune (e.g., delete files older than X days) and ensure custom emoji/profile-picture deletes also unlink their files.
If you want auto-delete to survive restarts, persist minimal metadata (file path + expiry) and rehydrate timers on boot.